// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © bearbearbull23

//@version=5
indicator("TDPO-RSI (Time-Decaying Percentile RSI)", overlay=false)

length     = input.int(20, minval=5, title="Lookback Length")
decay      = input.float(0.94, minval=0.80, maxval=0.99, title="Decay Factor λ")
smooth_len = input.int(5, minval=1, title="Smoothing EMA")

// Step 1: Compute delta
delta = close - close[1]
gain  = math.max(delta, 0)
loss  = math.max(-delta, 0)

// Step 2: Prepare arrays
var float[] gain_array   = array.new_float()
var float[] loss_array   = array.new_float()
var float[] weight_array = array.new_float()

// Step 3: Decay & prepend
if bar_index > length
    if array.size(weight_array) > 0
        for i = 0 to array.size(weight_array) - 1
            array.set(weight_array, i, array.get(weight_array, i) * decay)
    array.unshift(gain_array, gain)
    array.unshift(loss_array, loss)
    array.unshift(weight_array, 1.0)
    if array.size(gain_array) > length
        array.pop(gain_array)
        array.pop(loss_array)
        array.pop(weight_array)

// Step 4: Weighted percentile function
f_weighted_percentile(value, arr, weights) =>
    float num = 0.0, den = 0.0
    for i = 0 to array.size(arr) - 1
        v = array.get(arr, i), w = array.get(weights, i)
        if v < value
            num += w
        den += w
    den > 0 ? 100 * num / den : na

// Step 5: Percentiles
float gain_percentile = na
float loss_percentile = na
if array.size(gain_array) >= length
    gain_percentile := f_weighted_percentile(gain, gain_array, weight_array)
    loss_percentile := f_weighted_percentile(loss, loss_array, weight_array)

// Step 6: TDPO-RSI
float tdpo_rsi = na
if (gain_percentile + loss_percentile) > 0
    tdpo_rsi := 100 * gain_percentile / (gain_percentile + loss_percentile)

// Step 7: Smooth
tdpo_rsi_smooth = ta.ema(tdpo_rsi, smooth_len)

// Plot with blue line
hline(70, "Overbought", color=color.red)
hline(30, "Oversold", color=color.green)
plot(tdpo_rsi_smooth, title="TDPO-RSI", color=color.blue, linewidth=2)
plot(tdpo_rsi,        title="Raw TDPO-RSI", color=color.gray, linewidth=1, style=plot.style_stepline, transp=80)
