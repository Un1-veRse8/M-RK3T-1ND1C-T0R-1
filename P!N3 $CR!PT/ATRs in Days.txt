// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0
// © Yanni_Nicolaides

//@version=6
indicator("ATRs in Days", overlay=false)

// === INPUTS ===
days = input.int(title="Days", defval=5)
src  = input(close, title="Source")

// === MOVE CALCULATION ===
move = 0.0
for i = 0 to days
    distHigh = low - high[i]
    distLow  = high - low[i]
    maxDist  = math.max(math.abs(distHigh), math.abs(distLow))
    if maxDist > math.abs(move)
        move := maxDist
        // Flip the sign if the bigger distance is negative
        if math.abs(distHigh) > math.abs(distLow) and distHigh < 0
            move := move * -1
        if math.abs(distLow) > math.abs(distHigh) and distLow < 0
            move := move * -1

// === ATR CALCULATION ===
curAtr = ta.rma(ta.tr(true)[1], 20)
move := move / curAtr

// === BOLLINGER BAND CALCULATION ===
length = 20
mult   = 2
basis  = ta.sma(src, length)
dev    = mult * ta.stdev(src, length)
upperBollinger = basis + dev
lowerBollinger = basis - dev

// === MAIN PLOT (BLUE) ===
plotMove = plot(move, color=color.blue, title="Normalized ATR Move", linewidth=2)

// === PURPLE DOTS (MODIFIED) ===
signal = ((move >= 4 and open > upperBollinger) or (move <= -4 and open < lowerBollinger)) ? move : na
plot(signal, title="Signal", style=plot.style_circles, color=color.purple, linewidth=3)

// === HORIZONTAL THRESHOLDS AT +4 AND -4 ===
hline(4,  title="Upper Threshold (4)", color=color.gray, linewidth=2)
hline(-4, title="Lower Threshold (-4)", color=color.gray, linewidth=2)

// === PARTIAL PLOTS FOR FILL ===
overPlot  = plot(move >= 4  ? move : na, color=color.new(color.blue, 0), linewidth=2, display=display.none)
underPlot = plot(move <= -4 ? move : na, color=color.new(color.blue, 0), linewidth=2, display=display.none)

// === INVISIBLE LINES FOR FILL REFERENCES ===
plotUpperLine = plot(4,  title="Upper Invisible", color=color.new(color.white, 0), display=display.none)
plotLowerLine = plot(-4, title="Lower Invisible", color=color.new(color.white, 0), display=display.none)

// === FILL ABOVE +4 IN DARK GREEN, BELOW -4 IN DARK RED ===
fill(overPlot,  plotUpperLine, color=color.new(color.green, 80), title="Fill Above 4")
fill(underPlot, plotLowerLine, color=color.new(color.red,   80), title="Fill Below -4")

// === TABLE FOR ATR DISPLAY ===
var tablo = table.new(position=position.top_right, columns=2, rows=1, bgcolor=color.black, 
                      border_color=color.white, border_width=2, frame_width=1)

if bar_index == last_bar_index
    // ATR Row
    table.cell(tablo, 0, 0, text="ATR", bgcolor=color.blue, text_color=color.white)
    table.cell(tablo, 1, 0, text=str.tostring(math.round(curAtr * 100) / 100), bgcolor=color.black, text_color=color.white)
